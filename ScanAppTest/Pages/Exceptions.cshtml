@page
@using Kendo.Mvc.UI
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@Html.AntiForgeryToken()
@model ExceptionsModel
@{
    ViewData["Title"] = "Exceptions";
}


<br />
<h4>@Html.Label("application", "Apps")</h4>
<p id="appnametxt">Test</p>
@(Html.Kendo().DropDownList()
        .Name("apps")
        .DataTextField("AppName")
        .DataValueField("AppId")
        .HtmlAttributes(new { style = "width:300px;" })
        .OptionLabel("Vælg Applikation...")
        .Events(e => e.Change("onChange"))
        .Filter(FilterType.Contains)
        .DataSource(ds => ds
            .Custom()
            .Transport(transport => transport
                .Read(r => r
                    .Url(Url.Content("~/Exceptions?handler=AppList")).Data("dataFunction")
                ))
                .ServerFiltering(true)
            )
        .FooterTemplate("Total number of <strong>#: instance.dataSource.total() #</strong> apps found")
        )
@(Html.Kendo().Grid<ScanAppWeb.Models.ExViewModel>()
          .Name("grid")
          .Columns(columns =>
          {
              columns.Bound(e => e.AppName)
                  .Title("App")
                  .Width(200)
                  .HtmlAttributes(new { style = "font-size:10pt;" });
              columns.Bound(e => e.FileName)
                  .Width(275)
                  .HtmlAttributes(new { style = "font-size:10pt;" });
              columns.Bound(e => e.ExMsg)
                      .Title("Exception")
                      .HtmlAttributes(new { style = "font-size:8pt;" });
              columns.Command(command =>
              {
                  command.Custom("Details").Click("showDetails");
                  command.Destroy();
              }).Width(200);
          })
          .Pageable()
          .Sortable(sortable =>
          {
              sortable.SortMode(GridSortMode.SingleColumn);
          })
          .AutoBind(false)
          .DataSource(dataSource => dataSource
              .Ajax()
              .ServerOperation(false)
              .PageSize(5)
              .Model(model => { model.Id(e => e.ExceptionId);  })
              .Read(r => r.Url(Url.Content("~/Exceptions?handler=Get_Exceptions_By_Id")).Data("forgeryToken").Data("additionalData"))
          )
    )
@*@(Html.Kendo().Grid<ScanAppWeb.Models.ExViewModel>()
            .Name("Grid")
            .Columns(columns =>
            {
            columns.Bound(e => e.AppName)
                .Title("App")
                .Width(200)
                .HtmlAttributes(new { style = "font-size:10pt;" });
            columns.Bound(e => e.FileName)
                .Width(275)
                .HtmlAttributes(new { style = "font-size:10pt;" });
            columns.Bound(e => e.ExMsg)
                    .Title("Exception")
                    .HtmlAttributes(new { style = "font-size:8pt;" });
            columns.Command(command =>
            {
                command.Custom("Details").Click("showDetails");
                command.Destroy();
            }).Width(200);
            })
            .ToolBar(toolbar =>
            {
                toolbar.Search();
            })
            .Groupable()
            .Navigatable()
            .Scrollable()
            .Height(650)
            .AutoBind(true)
            .Filterable()
            .DataSource(dataSource => dataSource
                .Ajax()
                .Read(r => r.Url(Url.Content("~/Exceptions?handler=Read")).Data("forgeryToken"))
                .Destroy(d => d.Url(Url.Content("~/Exceptions?handler=Destroy")).Data("forgeryToken"))
                .Model(m => m.Id(id => id.ExceptionId))
            )
    )
    @(Html.Kendo().Window().Name("Details")
        .Title("Details")
        .Visible(false)
        .Modal(true)
        .Draggable(true)
        .Width(600)
    )*@

<script type="text/x-kendo-template" id="template">
    <div id="details-container">
        <p>#= ExMsg #</p>
        <p>File: #= FileName #</p>
        <ul>
        <em>
            <li>Line: #= Index #</li>
            <li>Date: #= Date #</li>
            <li>Previous lines: #= PreLines #</li>
        </em>
        </ul>
    </div>
</script>

<script type="text/javascript">

    var detailsTemplate;

    $(document).ready(function () {
        detailsTemplate = kendo.template($("#template").html());
    });

    function showDetails(e) {
        e.preventDefault();

        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var wnd = $("#Details").data("kendoWindow");

        wnd.content(detailsTemplate(dataItem));
        wnd.center().open();
    }
    function dataFunction() {
        var value = $("#apps").getKendoDropDownList().filterInput.val();
        return {
            __RequestVerificationToken: kendo.antiForgeryTokens().__RequestVerificationToken,
            filterValue: value
        };
    }

    function forgeryToken() {
        return kendo.antiForgeryTokens();
    }

    $(document).ready(function () {
        var app = $("#apps").data("kendoDropDownList");

        $("#get").click(function () {
            var appInfo = "\nApp: { appid: " + app.value() + ", appname: " + app.text() + " }";
        });
    });

    function additionalData(e) {
        var value = $("#apps").data("kendoDropDownList").value();
        return { appid: value }; // send the app id value as part of the Read request
    }

    function onChange() {
        var aid = this.value();
        var grid = $("grid").data("kendoGrid")

        $("#appnametxt").text("" + aid);
        @*grid.dataSource.transport.options.read.url = Url.Content("~/Exceptions?handler=Get_Exceptions_By_Id").Data("forgeryToken").Data("additionalData");
        grid.dataSource.read()*@
        @*alert(aid);*@
        @*$("#grid")*@
        @*$.get('/Exceptions/Get_Exceptions_By_Id', { appid: aid }, function (data) {
            var grid = $("#grid").data("kendoGrid");
            grid.dataSource.read(); // rebind the Grid's DataSource
        })*@
    }
</script>

<style>
    #details-container {
        padding: 10px;
    }

        #details-container h2 {
            margin: 0;
        }

        #details-container em {
            color: #8c8c8c;
        }

        #details-container dt {
            margin: 0;
            display: inline;
        }
</style>